apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-spb2-backend1-jaeger
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
    - SkipDryRunOnMissingResource=true
    - RespectIgnoreDifferences=true
  project: default
  ignoreDifferences:
    - group: rbac.authorization.k8s.io
      kind: ClusterRole
      name: argocd-manager-jaeger
      jsonPointers:
        - /metadata/labels/jit-rbac~1sync-status
    - group: rbac.authorization.k8s.io
      kind: ClusterRoleBinding
      name: argocd-manager-jaeger
      jsonPointers:
        - /metadata/labels/jit-rbac~1sync-status
    - group: rbac.authorization.k8s.io
      kind: ClusterRole
      name: jit-rbac-marker-k8s-spb2-backend1-jaeger
      jsonPointers:
        - /metadata/labels/jit-rbac~1sync-status
    - group: rbac.authorization.k8s.io
      kind: ClusterRoleBinding
      name: jit-rbac-marker-k8s-spb2-backend1-jaeger
      jsonPointers:
        - /metadata/labels/jit-rbac~1sync-status
  destination:
    name: kind-test-1
    namespace: jaeger
  sources:
    # Source 1: JIT RBAC (ClusterRole + ClusterRoleBinding)
    - repoURL: 'https://github.com/nomad-mrkn/0zargo.git'
      targetRevision: HEAD
      path: shared/jit-rbac-roles
      directory:
        include: jaeger-role.yaml
    # Source 2: Job wave 99
    - repoURL: 'https://github.com/nomad-mrkn/0zargo.git'
      targetRevision: HEAD
      path: shared/jit-rbac
      kustomize:
        commonLabels:
          jit-rbac/app: k8s-spb2-backend1-jaeger
        patches:
          - target:
              kind: ServiceAccount
              name: jit-rbac-marker-PLACEHOLDER
            patch: |-
              - op: replace
                path: /metadata/name
                value: jit-rbac-marker-k8s-spb2-backend1-jaeger
          - target:
              kind: ClusterRole
              name: jit-rbac-marker-PLACEHOLDER
            patch: |-
              - op: replace
                path: /metadata/name
                value: jit-rbac-marker-k8s-spb2-backend1-jaeger
          - target:
              kind: ClusterRoleBinding
              name: jit-rbac-marker-PLACEHOLDER
            patch: |-
              - op: replace
                path: /metadata/name
                value: jit-rbac-marker-k8s-spb2-backend1-jaeger
              - op: replace
                path: /roleRef/name
                value: jit-rbac-marker-k8s-spb2-backend1-jaeger
              - op: replace
                path: /subjects/0/name
                value: jit-rbac-marker-k8s-spb2-backend1-jaeger
              - op: replace
                path: /subjects/0/namespace
                value: jaeger
          - target:
              kind: Job
              name: PLACEHOLDER-mark-completed
            patch: |-
              - op: replace
                path: /metadata/name
                value: k8s-spb2-backend1-jaeger-mark-completed
              - op: replace
                path: /spec/template/spec/serviceAccountName
                value: jit-rbac-marker-k8s-spb2-backend1-jaeger
              - op: replace
                path: /spec/template/spec/containers/0/env/0/value
                value: k8s-spb2-backend1-jaeger
    # Source 3: Helm chart
    - repoURL: 'https://github.com/nomad-mrkn/charts.git'
      targetRevision: HEAD
      path: jaeger-operator
      helm:
        releaseName: k8s-spb2-backend1-jaeger
        values: |
          jaeger:
            create: true
            spec:
              strategy: production
              ingress:
                enabled: false
              agent:
                resources:
                  limits:
                    cpu: 2000m
                    memory: 1024Mi
                  requests:
                    cpu: 200m
                    memory: 128Mi
                sidecarSecurityContext:
                  allowPrivilegeEscalation: false
                  capabilities:
                    drop:
                      - ALL
                  runAsNonRoot: true
                  runAsUser: 1001
                  runAsGroup: 1001
                  seccompProfile:
                    type: RuntimeDefault
                image: ghcr.io/jaegertracing/jaeger-agent:1.49.0
              query:
                resources:
                  requests:
                    cpu: 100m
                    memory: 128Mi
                  limits:
                    cpu: 2000m
                    memory: 512Mi
                image: ghcr.io/jaegertracing/jaeger-query:1.49.0
                tolerations:
                  - key: "node-role.kubernetes.io/infr"
                    operator: "Exists"
                    effect: "NoSchedule"
                affinity:
                  nodeAffinity:
                    preferredDuringSchedulingIgnoredDuringExecution:
                      - weight: 1
                        preference:
                          matchExpressions:
                            - key: "node-role.kubernetes.io/infr"
                              operator: "Exists"
              collector:
                replicas: 24
                image: ghcr.io/jaegertracing/jaeger-collector:1.49.0
              options:
                collector:
                  num-workers: 2000
                  queue-size: 50000
              resources:
                requests:
                  cpu: 2000m
                  memory: 1536Mi
                limits:
                  cpu: 3000m
                  memory: 2Gi
              tolerations:
                - key: "node-role.kubernetes.io/infr"
                  operator: "Exists"
                  effect: "NoSchedule"
              affinity:
                nodeAffinity:
                  preferredDuringSchedulingIgnoredDuringExecution:
                    - weight: 1
                      preference:
                        matchExpressions:
                          - key: "node-role.kubernetes.io/infr"
                            operator: "Exists"
            storage:
              type: cassandra
              options:
                cassandra:
                  servers: cassandra-jaeger1.spb.dc,cassandra-jaeger2.spb.dc,cassandra-jaeger3.spb.dc
                  keyspace: jaeger_v1_ru_spb
              cassandraCreateSchema:
                enabled: false
              dependencies:
                enabled: false
              secretName: jaeger-secret
          rbac:
            create: true
            pspEnabled: false
            clusterRole: true
          resources:
            limits:
              cpu: 2
              memory: 512Mi
            requests:
              cpu: 1
              memory: 256Mi
          nodeSelector: {}
          tolerations:
            - key: "node-role.kubernetes.io/infr"
              operator: "Exists"
              effect: "NoSchedule"
          affinity:
            nodeAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 1
                  preference:
                    matchExpressions:
                      - key: "node-role.kubernetes.io/infr"
                        operator: "Exists"
