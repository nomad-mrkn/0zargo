---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jit-rbac-marker-PLACEHOLDER
  annotations:
    argocd.argoproj.io/sync-wave: "98"
  labels:
    app.kubernetes.io/part-of: argo-jit-rbac
    jit-rbac/app: PLACEHOLDER
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: jit-rbac-marker-PLACEHOLDER
  annotations:
    argocd.argoproj.io/sync-wave: "98"
  labels:
    app.kubernetes.io/part-of: argo-jit-rbac
    jit-rbac/app: PLACEHOLDER
rules:
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["clusterroles", "clusterrolebindings"]
    verbs: ["get", "list", "patch", "bind", "escalate"]
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jit-rbac-marker-PLACEHOLDER
  annotations:
    argocd.argoproj.io/sync-wave: "98"
  labels:
    app.kubernetes.io/part-of: argo-jit-rbac
    jit-rbac/app: PLACEHOLDER
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: jit-rbac-marker-PLACEHOLDER
subjects:
  - kind: ServiceAccount
    name: jit-rbac-marker-PLACEHOLDER
    namespace: PLACEHOLDER_NAMESPACE
---
apiVersion: batch/v1
kind: Job
metadata:
  name: PLACEHOLDER-mark-completed
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/sync-wave: "99"
  labels:
    app.kubernetes.io/part-of: argo-jit-rbac
    jit-rbac/app: PLACEHOLDER
spec:
  ttlSecondsAfterFinished: 60
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/part-of: argo-jit-rbac
        jit-rbac/app: PLACEHOLDER
    spec:
      serviceAccountName: jit-rbac-marker-PLACEHOLDER
      restartPolicy: Never
      containers:
      - name: mark-completed
        image: bitnami/kubectl:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: JIT_RBAC_APP
          value: PLACEHOLDER
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -euo pipefail
            echo "========================================="
            echo "Marking sync as completed for ${JIT_RBAC_APP}"
            echo "Started at $(date -u +%FT%TZ)"
            echo "========================================="
            
            MARKER_CR_NAME="jit-rbac-marker-${JIT_RBAC_APP}"
            if kubectl label clusterrole ${MARKER_CR_NAME} \
              jit-rbac/sync-status=completed --overwrite 2>/dev/null; then
              echo "Marker ClusterRole labeled successfully"
            else
              echo "Failed to label marker ClusterRole (may not exist yet)"
            fi
            
            if kubectl label clusterrole -l jit-rbac/app=${JIT_RBAC_APP} \
              jit-rbac/sync-status=completed --overwrite; then
              echo "Application ClusterRole labeled successfully"
            else
              echo "Failed to label Application ClusterRole"
              exit 1
            fi
            
            if kubectl label clusterrolebinding -l jit-rbac/app=${JIT_RBAC_APP} \
              jit-rbac/sync-status=completed --overwrite; then
              echo "ClusterRoleBinding labeled successfully"
            else
              echo "Failed to label ClusterRoleBinding"
              exit 1
            fi
            
            SA_NAME="jit-rbac-marker-${JIT_RBAC_APP}"
            SA_NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null || echo "")
            if [ -n "${SA_NAMESPACE}" ] && [ -n "${SA_NAME}" ]; then
              if kubectl label serviceaccount -n ${SA_NAMESPACE} ${SA_NAME} \
                jit-rbac/sync-status=completed --overwrite 2>/dev/null; then
                echo "ServiceAccount labeled successfully"
              else
                echo "Failed to label ServiceAccount (may not exist yet or no permissions)"
              fi
            else
              echo "Could not determine namespace or SA name, skipping ServiceAccount label"
            fi
            
            echo "========================================="
            echo "Successfully marked ${JIT_RBAC_APP} as completed"
            echo "Completed at $(date -u +%FT%TZ)"
            echo "========================================="
